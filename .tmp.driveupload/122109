"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const baileysManager_1 = require("../services/baileysManager");
const auth_1 = require("../middleware/auth");
const dbService_1 = require("../services/dbService");
const router = (0, express_1.Router)();
// Toutes les routes WhatsApp nécessitent une auth
router.use(auth_1.authenticateTenant);
// Vérifier le statut (et générer QR si nécessaire)
router.get('/status', async (req, res) => {
    try {
        const tenantId = req.tenantId;
        // Récupérer le statut actuel depuis la DB
        const tenant = await dbService_1.db.getTenantById(tenantId);
        if (!tenant) {
            res.status(404).json({ error: 'Tenant non trouvé' });
            return;
        }
        // Vérifier la session active en mémoire
        const session = await baileysManager_1.whatsappManager.getSession(tenantId);
        if (tenant.whatsappConnected && session?.status === 'connected') {
            res.json({
                connected: true,
                status: 'connected',
                phoneNumber: tenant.whatsappPhoneNumber
            });
            return;
        }
        // Si non connecté, s'assurer qu'une session de connexion est lancée pour avoir un QR
        if (!session || session.status === 'disconnected') {
            // Lancer la création de session en arrière-plan si pas déjà fait
            baileysManager_1.whatsappManager.createSession(tenantId).catch(console.error);
        }
        // Renvoyer le QR s'il est dispo en mémoire (ou attendre un peu ?)
        // Ici on renvoie ce qu'on a. Le frontend fera du polling.
        res.json({
            connected: false,
            status: session?.status || 'disconnected',
            qrCode: session?.qr
        });
    }
    catch (error) {
        console.error('Erreur status WhatsApp:', error);
        res.status(500).json({ error: error.message });
    }
});
// Déconnexion
router.post('/logout', async (req, res) => {
    try {
        const tenantId = req.tenantId;
        await baileysManager_1.whatsappManager.disconnect(tenantId);
        res.json({ success: true, message: 'Déconnecté avec succès' });
    }
    catch (error) {
        res.status(500).json({ error: error.message });
    }
});
exports.default = router;
